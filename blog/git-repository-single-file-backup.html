<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/assets/css/style.css?v=da38c0269ef5d015e8b2b9fff9182162a86de119">
  <link rel="stylesheet" href="/assets/css/fontawesome-all.css?v=da38c0269ef5d015e8b2b9fff9182162a86de119">
  <link rel="icon" type="image/png" href="/favicon.png" />
  <title>Creating a single-file backup of your git repository - Varun Barad</title>
  <meta name="description" content="I created a python script which creates a zip-file containing the git-bundle and all the patch-files for different stashed changes in your repository." />

  <!-- RSS Feed meta-data -->
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://varunbarad.com/feed.xml" />

  <!-- Twitter meta-data -->
  <meta name="twitter:site" content="@varun_barad" />
  <meta name="twitter:image:src" content="https://varunbarad.com/assets/images/logo-hd.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Creating a single-file backup of your git repository" />
  <meta name="twitter:description" content="I created a python script which creates a zip-file containing the git-bundle and all the patch-files for different stashed changes in your repository." />

  <!-- Open-graph meta-data -->
  <meta property="og:site_name" content="Varun Barad - Curious Developer" />
  <meta property="og:image" content="https://varunbarad.com/assets/images/logo-hd.png" />
  <meta property="og:type" content="object" />
  <meta property="og:title" content="Creating a single-file backup of your git repository" />
  <meta property="og:url" content="https://varunbarad.com/blog/git-repository-single-file-backup" />
  <meta property="og:description" content="I created a python script which creates a zip-file containing the git-bundle and all the patch-files for different stashed changes in your repository." />
</head>
<body>
<div>
  <div id="header">
    <div class="row header">
  <div class="title col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4">
    <a href="/"><div class="title">Varun Barad</div></a>
  </div>
  <div class="col-12 col-sm-6 col-md-8 col-lg-8 col-xl-8">
    <nav class="menu text-right">
  <a href="/portfolio">Portfolio</a>
  <a href="/blog">Blog</a>
  <a href="/contact">Contact</a>
</nav>

  </div>
</div>

  </div>
  <article class="h-entry">
    <div class="content row">
      <div class="post-container">
        <div class="col-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
          <div>
            <div class="page-title text-uppercase text-center p-name"><a class="u-url" href="https://varunbarad.com/blog/git-repository-single-file-backup">Creating a single-file backup of your git repository</a></div>
            <div class="text-center">
              By <a class="p-author h-card" rel="author" href="https://varunbarad.com">Varun Barad</a> on <time class="post-date dt-published" datetime="2019-03-03 12:00:00 +0530">March 03, 2019</time>
            </div>
            <div class="post-content e-content"><p>Last week I needed to take a backup of my laptop’s contents because I needed to give it for repair. When I started just plain copying my files to an external hard-drive I noticed that the git-files (the files used by git to store version-history for project) were taking too much time since they were very small in size but huge in numbers. So I decided to find a way using which I could create a single-file for each git enabled project and then just copy that single file over to the external hard-drive.</p>

<p>I came across two options provided by git itself:</p>

<ul>
  <li><code class="highlighter-rouge">git archive</code></li>
  <li><code class="highlighter-rouge">git bundle</code></li>
</ul>

<p><code class="highlighter-rouge">archive</code> creates just a snapshot of how the project is at that particular instance and does not contain any of the version-history stuff, so this option went out the window for me.</p>

<p><code class="highlighter-rouge">bundle</code> gave me the option to generate a single-file containing all of my version-history across all the branches. This appeared to me to be <strong>the solution</strong> that I was looking for.</p>

<p>But alas, <code class="highlighter-rouge">bundle</code> doesn’t store any data of the changes you have stashed in your local-repo.</p>

<p>After much searching I couldn’t find anything that gave me both the version-history and all the stashed changes in a single file. So I decided to write my own python script which would create zip file containing the bundle file generated by <code class="highlighter-rouge">git bundle</code> and patch-files for all the stashed changes in my repo.</p>

<p>I have described how I made the program in this article, though if you only want the script, I have put a link to the gist at the bottom of this article.</p>

<h2 id="project-breakdown">Project breakdown</h2>

<p>I decided to break the project down into parts and then conquer them one-by-one.</p>

<ul>
  <li>Getting the directory for which the git-backup needs to be generated</li>
  <li>Checking if that directory is actually the root directory for a git-enabled project</li>
  <li>Creating a <code class="highlighter-rouge">git bundle</code> file from within the python script</li>
  <li>Check if the project has any changes that haven’t been committed or stashed yet</li>
  <li>Stashing any changes that I find in the step above</li>
  <li>Check if the project has any stashed changes</li>
  <li>Creating individual patch-files for all the stashed changes found in previous step</li>
  <li>Creating a zip-file which contains the bundle file from git and all the patch-files that we created in previous step</li>
  <li>Deleting the bundle and patch-files since we already have them included in the zip-file</li>
</ul>

<h2 id="step-1-getting-the-directory">Step 1: Getting the directory</h2>

<p>I decided to give 2 options to the user. They can either:</p>

<ol>
  <li>Go to the directory via terminal and execute my script from there</li>
  <li>Provide the directory as a command-line argument to my script</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">arguments</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">directory_to_backup</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">directory_to_backup</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">directory_to_backup</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>
</code></pre></div></div>

<p>In python <code class="highlighter-rouge">sys.argv</code> returns a list of command-line arguments passed to our program.
Since the first item in that list is always the name of our program so we ignore it and take a look at the rest of the list.</p>

<p>If the rest of the list is empty, we take the first use-case in consideration, ie- the user has launched our program from the directory which they want to backup. Therefore we use <code class="highlighter-rouge">os.getcwd()</code> which returns the system’s current working-directory, which would be the directory from where our script was launched.</p>

<p>After that we use <code class="highlighter-rouge">os.path.abspath(directory_to_backup)</code> to clean the path provided to us and also convert it to absolute path as used by the system.</p>

<h2 id="step-2-checking-if-this-is-a-root-directory-for-a-git-project">Step 2: Checking if this is a root-directory for a git project</h2>

<p>Next up on the list was to check whether the directory that we are supplied is actually the root-directory for a project which has git initiated in it. This is very important since the rest of the script would just crash if we try to execute it on a folder which isn’t actually a git project.</p>

<p>I decided to just check for the presence of a <code class="highlighter-rouge">.git</code> folder inside the root folder that was supplied to us. Git stores all of its data for that project in a <code class="highlighter-rouge">.git</code> folder inside that project. If you people know of a better way to make this check do let me know.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">git_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">,</span> <span class="s">'.git'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">git_directory</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">git_directory</span><span class="p">):</span>
    <span class="n">create_backup_zip</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">directory_to_backup</span> <span class="o">+</span> <span class="s">' is not a git repository'</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">os.path.exists</code> checks for the existence of <code class="highlighter-rouge">git_directory</code> and <code class="highlighter-rouge">os.path.isdir</code> checks that it is actually a directory and not just a file named <code class="highlighter-rouge">.git</code>.</p>

<h2 id="step-3-creating-a-git-bundle-from-within-my-script">Step 3: Creating a git bundle from within my script</h2>

<p>Before this I had only created the git bundles from the terminal and never from within a python script. I had no idea how to do so.</p>

<p>First I decided that I would issue terminal commands from my script and capture the output of those commands. But then I thought that it probably might not work well across platforms (I am looking at you Windows).</p>

<p>I then went looking for a library in python to interact with git repositories. First result that Google came up with was <strong>GitPython</strong>.</p>

<p>I started reading the documentation for it and very quickly (like in under 5 minutes) started to get overwhelmed by all the git related concepts that it was throwing at me. But after around 10 minutes of searching, I found something that was helpful. I could get a handle on the <code class="highlighter-rouge">Repo</code> object for that git-project and then execute my git commands using that handle.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parent_directory</span><span class="p">,</span> <span class="n">directory_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>
<span class="n">repository</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>
<span class="n">git_handle</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">git</span>
<span class="n">git_bundle_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_directory</span><span class="p">,</span> <span class="p">(</span><span class="n">directory_name</span> <span class="o">+</span> <span class="s">'.bundle'</span><span class="p">))</span>
<span class="n">git_handle</span><span class="o">.</span><span class="n">bundle</span><span class="p">(</span><span class="s">'create'</span><span class="p">,</span> <span class="n">git_bundle_file_name</span><span class="p">,</span> <span class="s">'--all'</span><span class="p">)</span>
</code></pre></div></div>

<p>This is the equivalent of:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git bundle create &lt;git_bundle_name&gt; <span class="nt">--all</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">--all</code> flag is to include all the branches and not just the current branch.</p>

<h2 id="step-4-check-for-any-changes-that-arent-committed-or-stashed">Step 4: Check for any changes that aren’t committed or stashed</h2>

<p>Next I needed to check for any changes that haven’t been committed and also haven’t been stashed, so that we can stash them.</p>

<p>Just running <code class="highlighter-rouge">git status</code> gives me a list of the changed files, but it also outputs other things to make it human-friendly. There is an option <code class="highlighter-rouge">--porcelain</code> which strips all that extra info.</p>

<p>There are some files which have been left untracked, we don’t want to create a new stash when all of the uncommitted files are only files that are untracked. So we filter the lines by the value in their first column and remove any lines whose first-column value is made only of <code class="highlighter-rouge">?</code>. I don’t know what the values of first column mean, but I only know that <code class="highlighter-rouge">?</code> signifies files that are untracked. If our list of unstaged files is not empty after removing all untracked files, then we perform the next step or else we skip it.</p>

<h2 id="step-5-stash-any-changes-from-working-tree-and-staging-area">Step 5: Stash any changes from working tree and staging area</h2>

<p>If we find that we have any unstaged but not untracked files then we stash those changes. The command is a simple one.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">git_handle</span><span class="o">.</span><span class="n">stash</span><span class="p">(</span><span class="s">'push'</span><span class="p">,</span> <span class="s">'-m'</span><span class="p">,</span> <span class="s">'git-backup-stash'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="step-6-now-we-check-if-the-project-has-any-stashed-changes">Step 6: Now we check if the project has any stashed changes</h2>

<p>Now we check if the project has any stashed changes. We do this so that we can determine whether or not we need to make any patch files. Git has a simple command to list all the stashes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stashes</span> <span class="o">=</span> <span class="n">git_handle</span><span class="o">.</span><span class="n">stash</span><span class="p">(</span><span class="s">'list'</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">stash_list</span> <span class="o">=</span> <span class="n">stashes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stashes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stash_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="c"># Create patch-files here</span>
</code></pre></div></div>

<h2 id="step-7-create-patch-files-for-any-stashes-we-have">Step 7: Create patch files for any stashes we have</h2>

<p>Now we create patch files for any stashes that we have in our local repo. These files can then later be used to restore the changes that were stashed. Each stash entry gets its own patch file.</p>

<p>Format of the patch-file’s name is as below:</p>

<p><code class="highlighter-rouge">&lt;stash_name&gt;:&lt;branch_name&gt;:&lt;stash_message&gt;.txt</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stashes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stash_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">patch_files_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_directory</span><span class="p">,</span> <span class="s">'patch-files'</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">patch_files_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stash</span> <span class="ow">in</span> <span class="n">stash_list</span><span class="p">:</span>
        <span class="n">stash_name</span> <span class="o">=</span> <span class="n">stash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">': '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stash_branch_name</span> <span class="o">=</span> <span class="n">stash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">': '</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stash_message</span> <span class="o">=</span> <span class="s">': '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">': '</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
        
        <span class="n">patch_file_name</span> <span class="o">=</span> <span class="s">':'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">stash_name</span><span class="p">,</span> <span class="n">stash_branch_name</span><span class="p">,</span> <span class="n">stash_message</span><span class="p">])</span> <span class="o">+</span> <span class="s">'.txt'</span>
        <span class="n">patch_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patch_files_directory</span><span class="p">,</span> <span class="n">patch_file_name</span><span class="p">)</span>
        <span class="n">patch_contents</span> <span class="o">=</span> <span class="n">git_handle</span><span class="o">.</span><span class="n">stash</span><span class="p">(</span><span class="s">'show'</span><span class="p">,</span> <span class="s">'-p'</span><span class="p">,</span> <span class="n">stash_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">patch_file_path</span><span class="p">,</span> <span class="s">'x'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">patch_contents</span><span class="p">)</span>
        <span class="n">patch_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch_file_path</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="step-8-create-a-zip-file-of-the-bundle-and-all-the-patch-files">Step 8: Create a zip-file of the bundle and all the patch files</h2>

<p>Now all we need to do is integrate all of those above files into a single zip file. First we write the bundle file created by git into the zip file. Then we include the patch files, if we have any, into a sub-folder called “patch-files” in the zip file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">zip_file_name</span> <span class="o">=</span> <span class="n">directory_name</span> <span class="o">+</span> <span class="s">'.zip'</span>
<span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_directory</span><span class="p">,</span> <span class="n">zip_file_name</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s">'x'</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
    <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">git_bundle_file_name</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">git_bundle_file_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">patch_file</span> <span class="ow">in</span> <span class="n">patch_files</span><span class="p">:</span>
        <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">patch_file</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">'patch-files'</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">patch_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
</code></pre></div></div>

<h2 id="step-9-deleting-the-bundle-file-and-the-patch-files">Step 9: Deleting the bundle file and the patch files</h2>

<p>Not so fast buddy, we still need to delete that git-bundle file and those patch-files that we created. Since we already have included them in our zip file, we no longer need them and therefore should clean those.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">git_bundle_file_name</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">patch_files_directory</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="full-code">Full Code</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python3</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="n">Repo</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>

<span class="k">def</span> <span class="nf">create_backup_zip</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">):</span>
    <span class="n">parent_directory</span><span class="p">,</span> <span class="n">directory_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>
    <span class="n">git_handle</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">git</span>
    <span class="n">git_bundle_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_directory</span><span class="p">,</span> <span class="p">(</span><span class="n">directory_name</span> <span class="o">+</span> <span class="s">'.bundle'</span><span class="p">))</span>
    <span class="n">git_handle</span><span class="o">.</span><span class="n">bundle</span><span class="p">(</span><span class="s">'create'</span><span class="p">,</span> <span class="n">git_bundle_file_name</span><span class="p">,</span> <span class="s">'--all'</span><span class="p">)</span>
    
    <span class="n">pattern_for_untracked_files_flag</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'^\?+$'</span><span class="p">)</span>
    <span class="n">non_staged_files_raw_output</span> <span class="o">=</span> <span class="n">git_handle</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">'--porcelain'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_staged_files_raw_output</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">non_staged_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pattern_for_untracked_files_flag</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">non_staged_files_raw_output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)))</span>
        <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">non_staged_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_staged_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">git_handle</span><span class="o">.</span><span class="n">stash</span><span class="p">(</span><span class="s">'push'</span><span class="p">,</span> <span class="s">'-m'</span><span class="p">,</span> <span class="s">'git-backup-stash'</span><span class="p">)</span>
    
    <span class="n">stashes</span> <span class="o">=</span> <span class="n">git_handle</span><span class="o">.</span><span class="n">stash</span><span class="p">(</span><span class="s">'list'</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">stash_list</span> <span class="o">=</span> <span class="n">stashes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
    <span class="n">patch_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stashes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stash_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">patch_files_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_directory</span><span class="p">,</span> <span class="s">'patch-files'</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">patch_files_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stash</span> <span class="ow">in</span> <span class="n">stash_list</span><span class="p">:</span>
            <span class="n">stash_name</span> <span class="o">=</span> <span class="n">stash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">': '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">stash_branch_name</span> <span class="o">=</span> <span class="n">stash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">': '</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">stash_message</span> <span class="o">=</span> <span class="s">': '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">': '</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
            
            <span class="n">patch_file_name</span> <span class="o">=</span> <span class="s">':'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">stash_name</span><span class="p">,</span> <span class="n">stash_branch_name</span><span class="p">,</span> <span class="n">stash_message</span><span class="p">])</span> <span class="o">+</span> <span class="s">'.txt'</span>
            <span class="n">patch_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patch_files_directory</span><span class="p">,</span> <span class="n">patch_file_name</span><span class="p">)</span>
            <span class="n">patch_contents</span> <span class="o">=</span> <span class="n">git_handle</span><span class="o">.</span><span class="n">stash</span><span class="p">(</span><span class="s">'show'</span><span class="p">,</span> <span class="s">'-p'</span><span class="p">,</span> <span class="n">stash_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">patch_file_path</span><span class="p">,</span> <span class="s">'x'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">patch_contents</span><span class="p">)</span>
            <span class="n">patch_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch_file_path</span><span class="p">)</span>
    
    <span class="n">zip_file_name</span> <span class="o">=</span> <span class="n">directory_name</span> <span class="o">+</span> <span class="s">'.zip'</span>
    <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_directory</span><span class="p">,</span> <span class="n">zip_file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s">'x'</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
        <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">git_bundle_file_name</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">git_bundle_file_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">patch_file</span> <span class="ow">in</span> <span class="n">patch_files</span><span class="p">:</span>
            <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">patch_file</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">'patch-files'</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">patch_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">git_bundle_file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">patch_files_directory</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">zip_file_name</span> <span class="o">+</span> <span class="s">' created'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">directory_to_backup</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">directory_to_backup</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">directory_to_backup</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>

    <span class="n">git_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">,</span> <span class="s">'.git'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">git_directory</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">git_directory</span><span class="p">):</span>
        <span class="n">create_backup_zip</span><span class="p">(</span><span class="n">directory_to_backup</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">directory_to_backup</span> <span class="o">+</span> <span class="s">' is not a git repository'</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="https://gist.github.com/VarunBarad/c291e98dd426b0da1322171290d7bbd0">GitHub gist: https://gist.github.com/VarunBarad/c291e98dd426b0da1322171290d7bbd0</a></p>

<h2 id="thats-all-folks">That’s all folks</h2>

<p>This is my solution to the problem I faced of taking a backup of my projects which also included unfinished work of mine. If you have any other suggestions regarding these or any other topics under the sky, <a href="https://varunbarad.com/contact">contact me</a> or tweet to me <a href="https://twitter.com/varun_barad">@varun_barad</a>.</p>

</div>
          </div>

          <div class="post-categories-container">
            Categories:
            <div>
              
              <a href="/category/tools" class="badge badge-warning p-category">#tools</a>
              
              <a href="/blog" class="badge badge-warning">#all</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </article>
  <div>
    <div class="footer">
  <div>
    
    <a href="https://github.com/VarunBarad" rel="me" target="_blank"><i class="fab fa-github social-links"></i></a>
    
    <a href="https://twitter.com/varun_barad" rel="me" target="_blank"><i class="fab fa-twitter social-links"></i></a>
    
    <a href="https://dev.to/varunbarad" rel="me" target="_blank"><i class="fab fa-dev social-links"></i></a>
    
    <a href="https://stackoverflow.com/users/4717436/varunbarad" rel="me" target="_blank"><i class="fab fa-stack-overflow social-links"></i></a>
    
  </div>
  <div class="developer-attribution">
    
    Made by <a href="https://dixita0607.github.io" target="_blank">Dixita Ganatra</a>
  </div>
</div>

  </div>
</div>

<script src="/assets/js/jquery.min.js?v=da38c0269ef5d015e8b2b9fff9182162a86de119"></script>
<script src="/assets/js/bootstrap.min.js?v=da38c0269ef5d015e8b2b9fff9182162a86de119"></script>
<script src="/assets/js/contact.js?v=da38c0269ef5d015e8b2b9fff9182162a86de119"></script>
</body>
</html>
